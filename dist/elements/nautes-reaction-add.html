<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-drag-drop/core-drag-drop.html">
<link rel="import" href="../bower_components/core-icon/core-icon.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">

<link rel="import" href="../elements/fd-rest-element-service.html">
<link rel="import" href="../elements/nautes-trigger.html">
<link rel="import" href="../elements/nautes-condition.html">
<link rel="import" href="../elements/nautes-command.html">

<polymer-element name="nautes-reaction-add" attributes="bgColor newReaction">
  <template>
    <style>

      :host {
        display: block;
        font-size: 1em;
        font-family: Verdana;
        color: #444;
      }

      .box {
        width: 320px;
        height: 200px;
        margin: 10px;
        overflow-y: scroll;
        border-radius: 10px;
        padding: 10px;
      }

      .dropped {
        position: absolute;
        border: 1px solid black;
        width: 5px;
        height: 5px;
      }

      #reaction{
        background-color: rgba(0,0,0,0.2);
        border-radius: 10px;
        padding: 10px;
      }

      .reaction{
        margin: 5px;
        background-color: #fcc;
      }

      .triggers {
        background-color: #fdf;
      }

      .conditions {
        background-color: #cfc;
      }

      .commands {
        background-color: #f88;
      }

      .drop{
        width: 300px;
        background-color: rgba(0,0,0,0.3);
        border-radius: 10px;
      }

      .dropicon{
        height: 50px;
        width: 50px;
      }

      .list-title{
        text-align: center;
        font-weight: bold;
        padding: 4px;
      }

      .new-reaction{
        color: #fff;
      }

      core-icon-button{
        border: 1px solid rgba(64,64,64,0.3);
      }

    </style>

    <fd-rest-element-service 
      fdtype="triggers" 
      fditems="{{triggers}}" 
      toast="{{toast}}">
    </fd-rest-element-service>

    <fd-rest-element-service 
      fdtype="commands/user" 
      fditems="{{commands}}" 
      toast="{{toast}}">
    </fd-rest-element-service>

    <fd-rest-element-service id="sendReactionService" 
      auto="false"
      method="POST" 
      fdtype="reactions" 
      fditems="{{commands}}" 
      toast="{{toast}}"
      params="{{newReaction}}">
    </fd-rest-element-service>


    <core-drag-drop on-drag-start="{{dragStartHandler}}"></core-drag-drop>

    <div vertical layout center>

      <div layout horizontal center>

        <div class="box triggers" draggable="false">
          <div class="list-title" draggable="false">
            TRIGGER LIST
          </div>
          <div style="background-color: #fdf;" draggable="false" layout vertical center>
            <template repeat="{{trigger in triggers}}">
              <nautes-trigger id="trigger" style="background-color: #fdf;"  trigger="{{trigger}}">{{trigger.name}}</nautes-trigger>
            </template>
          </div>
        </div>

        <div class="box conditions">
          <div class="list-title" draggable="false">
            CONDITION LIST
          </div>
          <div style="background-color: #cfc;" draggable="false" layout vertical center>
            <template repeat="{{condition in commands}}">
              <nautes-condition id="condition" style="background-color: #cfc;"  condition="{{condition}}">{{condition.name}}</nautes-condition>
            </template>
          </div>
        </div>

        <div class="box commands">
          <div class="list-title" draggable="false">
            COMMAND LIST
          </div>
          <div style="background-color: #f88;" draggable="false" layout vertical center>
            <template repeat="{{command in commands}}">
              <nautes-command id="command" style="background-color:  #f88;"  command="{{command}}">{{command.name}}</nautes-command>
            </template>
          </div>
        </div>
      </div>

      <div hidden>
        <div id="triggerIcon" layout vertical center center-justified>
          <core-icon class="icon" icon="image:flash-on"></core-icon>
        </div>
        <div id="conditionIcon">
          <core-icon class="icon" icon="send"></core-icon>
        </div>
        <div id="commandIcon">
          <core-icon class="icon" icon="send"></core-icon>
        </div>
      </div>

      <br><br>

      <div id="reaction" vertical layout center>
        <div class="new-reaction">NEW REACTION</div>
        <div layout horizontal center>

          <div class="box triggers" draggable="false" layout vertical center>
            <div>{{newReaction.trigger.name}}</div>
            <div id="dropTrigger" class="drop" flex layout vertical center center-justified>
              <div id="dropTrigger">DRAG ONE TRIGGER HERE</div>
              <core-icon id="dropTrigger" class="dropicon" icon="add"></core-icon>
            </div>
          </div>

          <div class="box conditions" draggable="false" layout vertical center>
            <template repeat="{{conditionNR in newReaction.conditions}}">
              <div>{{conditionNR.name}}</div>
            </template>
            <div id="dropConditions" class="drop" flex layout vertical center center-justified>
              <div id="dropConditions">DRAG CONDITIONS HERE</div>
              <core-icon id="dropConditions" class="dropicon" icon="add"></core-icon>
            </div>
          </div>

          <div class="box commands" draggable="false" layout vertical center>
            <template repeat="{{commandNR in newReaction.commands}}">
              <div>{{commandNR.name}}</div>
            </template>
            <div id="dropCommands" class="drop" flex layout vertical center center-justified>
              <div id="dropCommands">DRAG COMMANDS HERE</div>
              <core-icon id="dropCommands" class="dropicon" icon="add"></core-icon>
            </div>
          </div>

        </div>
        <div>
          <template if="{{canSendReaction}}">
            <core-icon-button class="reaction" icon="add-box" on-tap="{{sendReaction}}">
             ADD REACTION
            </core-icon-button>
          </template>
        </div>
      </div>

    </div>

  </template>
  <script>

    Polymer("nautes-reaction-add",{

      canSendReaction: false,

      newReaction: null,

      created: function(){
        this.newReaction = {
          trigger: {}, 
          conditions: [],
          commands: []
        };
      },

      checkReaction: function(){
        if(this.newReaction && this.newReaction.trigger && (this.newReaction.commands.length > 0)){
          this.canSendReaction = true;
        } else {
          this.canSendReaction = false;
        }
      },

      sendReaction: function(){
        this.$.sendReactionService.go();
      },

      dragStartHandler: function(e){

        //function executed when dropping element
        var self = this;
        var drop = function(dragInfo) {
          var color = dragInfo.avatar.style.borderColor;
          var target = dragInfo.event.target;
          var dropTarget = dragInfo.event.relatedTarget;

          if (dropTarget.id === 'dropTrigger' && target.id==="trigger") {
            self.newReaction.trigger = target.trigger;
          } else if (dropTarget.id === 'dropConditions' && target.id==="condition") {
            self.newReaction.conditions.push(target.condition);
          } else if (dropTarget.id === 'dropCommands' && target.id==="command") {
            self.newReaction.commands.push(target.command);
          }

          self.checkReaction();

        }
        
        //set avatar icon
        var dragInfo = e.detail;
        var color = dragInfo.event.target.style.backgroundColor;
        dragInfo.avatar.style.cssText = 'border: 3px solid ' + color + '; width: 32px; height: 32px; border-radius: 32px; background-color: whitesmoke';
        var icon = null;
        var id = dragInfo.event.target.id;
        if(id === "trigger"){
          icon = this.$.triggerIcon;
        } else if(id === "condition"){
          icon = this.$.conditionIcon;
        } else if(id === "command"){
          icon = this.$.commandIcon;
        }
        while (dragInfo.avatar.firstChild) {
            dragInfo.avatar.removeChild(dragInfo.avatar.firstChild);
        }
        if(icon){
          dragInfo.avatar.appendChild(icon);
        }

        dragInfo.drag = function() {};
        dragInfo.drop = drop;
      }

    });
  </script>
</polymer-element>
