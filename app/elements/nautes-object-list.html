<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../elements/fd-rest-element-service.html">

<link rel="import" href="../elements/nautes-object-row.html">
<link rel="import" href="../elements/nautes-fd-websocket-api-service.html">
<link rel="import" href="../elements/nautes-globals.html">

<polymer-element name="nautes-object-list" attributes="bgColor toast">
  <template>
    <style>
      :host {
        display: block;
        background-color: {{bgColor}};
      }
    </style>

    <nautes-globals values="{{globals}}"></nautes-globals>

    <fd-rest-element-service fdtype="objects" fditems="{{objects}}" toast={{toast}}>
    </fd-rest-element-service>

    <nautes-fd-websocket-api-service wstype="objectchange" on-message="{{updateObject}}">
    </nautes-fd-websocket-api-service>

    <core-ajax
      id="objGetRequest"
      url="https://{{globals.apiurl}}objects/{{objectUpdating.uuid}}"
      on-core-response="{{handleGetResponse}}"
      on-core-error="{{errorGetHandler}}"
      method="GET"
      handleAs="json"
      withCredentials>
    </core-ajax>

    <div layout vertical center>
      <template repeat="{{obj in objects}}">
        <nautes-object-row bgColor="{{bgColor}}">
          <img src="{{getImg(obj)}}" width="50" height="50">
          <h2>{{obj.name}}</h2>
          <p>{{obj.description}}</p>
        </nautes-object-row>
      </template>
    </div>    
    
  </template>


  <script>
    Polymer("nautes-object-list",{
      objectUpdatingIndex: 0,
      objectUpdating: {},
      getImg: function(obj) {
        var icon = obj.representation[obj.currentRepresentation].icon;
        if(icon != null){
          var src = 'https://fritz.bestmazzo.it:9113/v3/resources/' + icon ;
          return src;
        }
      },
      updateObject: function(event){
        var uuid = event.detail.data.uuid;

        if(uuid !== undefined){
        
          for (var i = 0; i < this.objects.length; i++) {
            var obj = this.objects[i];

            if (obj.uuid === uuid) {
              console.log("Object List - Asynch update of: " + uuid);
              this.objectUpdating = obj;
              this.objectUpdatingIndex = i;
              this.$.objGetRequest.go();
            }

          }
        }
      },
      handleGetResponse: function(response){
          this.objects[this.objectUpdatingIndex] = response.detail.response;
      }
    });
  </script>
</polymer-element>
