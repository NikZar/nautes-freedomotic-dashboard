<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">

<link rel="import" href="../elements/nautes-globals.html">

<polymer-element name="nautes-zone-object" attributes="envObject toast">
  <template>
    <style>
      :host {
        display: block;
        position: absolute;
        z-index: 1000;
        left: {{envObject.representation[0].offset.x}}px;
        top: {{envObject.representation[0].offset.y}}px;
      }
    </style>

    <nautes-globals values="{{globals}}"></nautes-globals>

    <img id="envObjectImg" on-tap="{{onTap}}" src="{{getImg()}}" width="50" height="50" alt="{{envObject.name}}" title="{{envObject.name}}">

    <core-ajax
      id="objTapRequest"
      url="{{globals.apiurl}}objects/{{envObject.uuid}}/click"
      on-core-response="{{handleTapResponse}}"
      on-core-error="{{errorTapHandler}}"
      method="POST"
      withCredentials>
    </core-ajax>

    <core-ajax
      id="objGetRequest"
      url="{{globals.apiurl}}objects/{{envObject.uuid}}"
      on-core-response="{{handleGetResponse}}"
      on-core-error="{{errorGetHandler}}"
      method="GET"
      handleAs="json"
      withCredentials>
    </core-ajax>

  </template>
  <script>
    Polymer("nautes-zone-object",{
      errorGetHandler: function(event){
        if(this.toast){
          this.toast.text="There was a problem loading "+this.envObject.name+" data.";
          this.toast.show();
        }
      },
      errorTapHandler: function(event){
        if(this.toast){
          this.toast.text="There was a server problem during "+this.envObject.name+" interaction.";
          this.toast.show();
        }
      },
      handleGetResponse: function(response){
          this.envObject = response.detail.response;
          this.$.envObjectImg.src = this.getImg();
        },
      handleTapResponse: function(response){
          this.$.objGetRequest.go();
        },
      onTap: function(){
          this.$.objTapRequest.go();
        },
      getImg: function() {
        var obj = this.envObject;
        if(obj){
          var icon = obj.representation[obj.currentRepresentation].icon;
          if(icon){
            var src = this.globals.apiurl + "resources/" + icon;
            return src;
          } 
        }
      }
    });
  </script>
</polymer-element>
