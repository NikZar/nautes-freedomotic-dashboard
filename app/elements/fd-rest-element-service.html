<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-localstorage/core-localstorage.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<polymer-element name="fd-rest-element-service" attributes="fditems fdtype toast apiurl protocol credentialrequired">
  <template>
    <style>
    :host {
      display: block;
    }
    </style>

    <core-localstorage
      name="protocol" 
      value="{{protocol}}">
    </core-localstorage>

    <core-localstorage
      name="apiurl" 
      value="{{apiurl}}">
    </core-localstorage>

    <core-localstorage
      name="credentialrequired" 
      value="{{credentialrequired}}">
    </core-localstorage>
    
    <core-ajax id="ajax" 
      auto
      on-core-error="{{errorHandler}}"
      on-core-response="{{elementsLoaded}}"
      response="{{fditems}}"
      handleAs="json"> 
    </core-ajax>

  </template>
  <script>
  Polymer('fd-rest-element-service', {

    alwaysPrepare: true,
    
    fdtype:'environments',
    
    created: function() {
      this.fditems = [];
    },

    reloadUrl: function(){
      this.$.ajax.url = this.protocol +"://"+ this.apiurl + this.fdtype +"/";
    },

    apiurlChanged: function(){
      if(this.apiurl){
        this.reloadUrl();
      }
    },

    protocolChanged: function(){
      if(this.protocol){
        this.reloadUrl();
      }
    },

    credentialrequiredChanged: function(){
      if(this.credentialrequired){
        this.$.ajax.withCredentials =  this.credentialrequired;
      }
    },

    elementsLoaded: function() {

      // Make a copy of the loaded data
      this.fditems = this.$.ajax.response.slice(0);

    },
    
    errorHandler: function(event){
      console.log(event);
      if(this.toast){
        this.toast.text="There was a problem loading "+this.fdtype+" data.";
        this.toast.show();
      }
    }
    
  });
  </script>
</polymer-element>