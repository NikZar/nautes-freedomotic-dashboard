<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-localstorage/core-localstorage.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/voice-elements/dist/voice-recognition.html">
<link rel="import" href="../bower_components/voice-elements/dist/voice-player.html">
<link rel="import" href="../bower_components/core-icons/av-icons.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">


<link rel="import" href="../elements/fd-rest-element-service.html">

<polymer-element name="nautes-stats" attributes="ssl apiurl stats">
  <template>

    <style>

      :host {
        display: block;
        color: #777;
      }

      #result{
        margin-top: 10px;
        text-transform: uppercase;
        text-align: center;
        font-family: Verdana;
        font-size: 1.5em;
      }

      .voice-elements{
        margin-top: 10px;
        background-color: rgba(255, 255, 255, 0.4);
        border: 3px solid rgba(255, 255, 255, 0.6);
        border-radius: 10px;
        padding: 30px;
        width: 400px;
        color: #444;
      }

      .fab{
        margin: 10px;
        background-color: #9f9;
        color: #444;
      }
    </style>

    <fd-rest-element-service fdtype="commands/user/93dfb9ab-2b38-4c07-a7f3-d4b5caf2d05b/run" fditems="{{ stats }}" toast={{ toast }} method="POST">
    </fd-rest-element-service>

    <div unresolved class="chart-container" layout horizontal center center-justified>
      <google-chart id="chart"
        type='line'
        height='200px'
        width='500px'
        options = '{"backgroundColor": "transparent"}'
        data='{{chartData}}'>
      </google-chart>
    </div>

    <!-- Log in console -->

    <core-localstorage
      name="ssl" 
      value="{{ ssl }}">
    </core-localstorage>

    <core-localstorage
      name="apiurl" 
      value="{{ apiurl }}">
    </core-localstorage>

    <core-localstorage
      name="credentialrequired" 
      value="{{ credentialrequired }}">
    </core-localstorage>

    <core-ajax
      id="statsRequest"
      on-core-response="{{ handleStatsResponse }}"
      on-core-error="{{ errorTapHandler }}"
      method="POST"
      withCredentials="{{ credentialrequired }}">
    </core-ajax>

    <div layout vertical center>

      <div class="row-fab" horizontal center-justified layout>
        <paper-fab class="fab" icon="arrow-forward" on-tap="{{go}}"></paper-fab>
      </div>

      <div class="voice-elements">

        <voice-recognition id="recognition" on-result="{{displayRecognition}}"></voice-recognition>
        <voice-player id="player" accent="it-IT" text="{{textVE}}"></voice-player>

        <div horizontal center-justified layout>
          <paper-fab class="fab" icon="av:mic" on-tap="{{startRecognition}}"></paper-fab>
          <paper-fab class="fab" icon="av:play-arrow" on-tap="{{speak}}"></paper-fab>
        </div>

        <div id="result" horizontal center-justified layout>{{textVE}}</div>

      </div>

    </div>



  </template>

  <script>
    Polymer("nautes-stats",{

      textVE: "Questa dashboard Ã¨ fantastica",

      chartData: [["Date", "Value"]],

      created: function(){
        this.chartData = [["Date", "Value"]];
      },

      reloadUrl: function(){
        if(this.ssl != undefined && this.apiurl){
          this.$.statsRequest.url = (this.ssl ? "https" : "http") + "://" + this.apiurl + "commands/user/93dfb9ab-2b38-4c07-a7f3-d4b5caf2d05b/run";
          console.log(this.$.statsRequest.url);
        }
      },

      sslChanged: function(){
        this.reloadUrl();
      },

      apiurlChanged: function(){
        this.reloadUrl();
      },

      statsChanged: function(){
        if(this.stats && this.stats.properties && this.stats.properties.tuples){
          var tuples = this.stats.properties.tuples.tuples;
          for (var i=0; i<tuples.length; i++) {
            var tuple = tuples[i];
            var strdate = tuple.datetime.replace("CEST","");
            var milliseconds = Date.parse(strdate);
            var date = new Date(milliseconds);
            var value = (tuple.behaviorValue ? 1 : 0);
            //console.log("Stat #"+i+":", date, value)
            this.chartData[i+1] = [date, value];
          }
          this.$.chart.type = "stepped-area";
          this.$.chart.drawChart();
          //this.chartData = JSON.stringify(this.chartData);
          console.log(this.chartData);
        }
      },

      handleStatsResponse: function(response){
        console.log(response.detail.response);
      },

      go: function(){
        this.$.statsRequest.go();
      },

      startRecognition: function(){
        this.$.recognition.start();
      },

      displayRecognition: function(event){
        this.textVE = event.detail.result;
      },

      speak: function(){
        this.$.player.speak();
      }

    });
  </script>
</polymer-element>
